<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOADING...</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
    </style>
</head>
<body>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const linkId = urlParams.get('id');
        const links = JSON.parse(localStorage.getItem('trackingLinks')) || {};
        const linkData = links[linkId];
        
        if (linkData) {
            const clickData = { timestamp: Date.now() };
            
            //Deteksi Device & OS dari User-Agent
            const ua = navigator.userAgent.toLowerCase();
            let device = "Unknown Device";
            let os = "Unknown OS";
            
            // Device brand
            if (ua.includes("oppo")) device = "Oppo";
            else if (ua.includes("vivo")) device = "Vivo";
            else if (ua.includes("xiaomi")) device = "Xiaomi";
            else if (ua.includes("redmi")) device = "Xiaomi (Redmi)";
            else if (ua.includes("samsung")) device = "Samsung";
            else if (ua.includes("realme")) device = "Realme";
            else if (ua.includes("huawei")) device = "Huawei";
            else if (ua.includes("infinix")) device = "Infinix";
            else if (ua.includes("asus")) device = "Asus";
            else if (ua.includes("iphone")) device = "iPhone";
            else if (ua.includes("ipad")) device = "iPad";
            
            // OS
            if (ua.includes("android")) os = "Android";
            else if (ua.includes("iphone") || ua.includes("ipad") || ua.includes("ipod")) os = "iOS";
            else if (ua.includes("win")) os = "Windows";
            else if (ua.includes("mac")) os = "MacOS";
            else if (ua.includes("linux")) os = "Linux";
            
            clickData.device = device;
            clickData.os = os;
            
            // Dapatkan info IP
            fetch('https://ipapi.co/json/?ip_version=4')
                .then(response => response.json())
                .then(ipInfo => {
                    clickData.ipInfo = {
                        ip: ipInfo.ip,
                        city: ipInfo.city,
                        country: ipInfo.country_name
                    };
                    
                    // Coba dapatkan lokasi
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            position => {
                                clickData.location = {
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude
                                };
                                saveAndRedirect();
                            },
                            () => saveAndRedirect(),
                            { timeout: 5000 }
                        );
                    } else {
                        saveAndRedirect();
                    }
                })
                .catch(() => saveAndRedirect());
            
            function saveAndRedirect() {
                linkData.clicks = [clickData];
                links[linkId] = linkData;
                localStorage.setItem('trackingLinks', JSON.stringify(links));
                window.location.href = linkData.targetUrl;
            }
            
        } else {
            document.body.innerHTML = '<h1>Error: Tautan tidak valid</h1>';
        }
    </script>
</body>
</html>
